<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/css/style.css" />
    
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.3.0/semantic.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.3.0/semantic.js"></script>
    
    <script src="/js/highlight.pack.js"></script>
  </head>
  
  <body>
    <div class="ui container">
      <div class="ui top fixed inverted compact icon menu">
      
        
        <a class="item" href="/">
  <i class="large home icon"></i>
  Home
</a>

<div class="ui dropdown item">
  <i class="code icon"></i>
  Web Developement
  <i class="dropdown icon"></i>
  <div class="menu">
    <a class="item">
      <img class = "ui top aligned right floated image" src="http://hexb.in/hexagons/shiny.png">
      <div class="content">
        <h5 class="ui header">
          Shiny Apps
          <div class="gray sub header">Web Applicationin R</div>
        </h5>
      </div>
    </a>
    <a class="item" href="/semanticui/">
      <img class = "ui tiny right floated middle aligned image" src="https://semantic-ui.com/images/logo.png">
      <div class="content">
        <h5 class="ui header">
          Semantic UI
          <div class="gray sub header">Beautiful Web</div>
        </h5>
      </div>
    </a>
  </div>
</div>
<div class="right compact menu">
  <a class="item" href="/teaching/">
    <i class="graduation icon"></i>
    Teaching
  </a>
  <div class="ui dropdown item">
    <i class="archive icon"></i>
    Blog Archive
    <i class="dropdown icon"></i>
    <div class="menu">
      <a class="item" href="/categories/">
        <i class="tag icon"></i>  
        Categories
      </a>
      <a class="item" href="/tags/">
        <i class="tags icon"></i>  
        Tags
      </a>
    </div>
  </div>
  <a class="item" href="/about/">About</a>
</div>







      </div>
      <br>
      <br>
    </div>
      <div class="ui inverted vertical center aligned segment">
    <br>
    <br>
    <div class="ui text container">
      <h1 class="ui inverted header", style = "font-size:40px">
        Text Classification in R
      </h1>
      <br>
      <br>
      <br>
    </div>
  </div>
  <br>
  
  <div class="ui grid">
    <br>
    <div class="three wide column"></div>
    <div class="ten wide column">
        



    

<div class="article-meta">
<h1><span class="title">Text Classification in R</span></h1>

<h2 class="date">2018/03/06</h2>
</div>

<main>
  <ul>
<li><a href="https://www.datacamp.com/community/tutorials/keras-r-deep-learning" class="uri">https://www.datacamp.com/community/tutorials/keras-r-deep-learning</a></li>
</ul>
<div id="load-packages" class="section level2">
<h2>Load Packages</h2>
<pre class="r"><code>#pacman::p_load_gh(&quot;rstudio/keras&quot;)
#pacman::p_load_gh(&quot;systats/tidyTX&quot;, install = T)
#devtools::install_github(&quot;systats/tidyTX&quot;)
pacman::p_load(dplyr, stringr, manifestoR, purrr, keras, tidyr, tidytext, tidyTX, keras, ggplot2, viridis, ggthemes)
# keras::install_keras()</code></pre>
</div>
<div id="load-data-by-manifestor" class="section level2">
<h2>Load data by <code>manifestoR</code></h2>
<pre class="r"><code>mkey &lt;- &quot;c1d709849c34e15130f9052699c214af&quot;
mp_setapikey(key = mkey)

# edate = Day, month, and year of national election
df &lt;- mp_corpus(
    countryname == &quot;Germany&quot; &amp;
    edate &gt; as.Date(&quot;2002-01-01&quot;)
  ) %&gt;%
  tidy()</code></pre>
<pre class="r"><code>glimpse(df)</code></pre>
<pre><code>## Observations: 28
## Variables: 17
## $ manifesto_id                &lt;chr&gt; &quot;41113_200209&quot;, &quot;41113_200509&quot;, &quot;4...
## $ party                       &lt;dbl&gt; 41113, 41113, 41113, 41113, 41113,...
## $ date                        &lt;dbl&gt; 200209, 200509, 200909, 201309, 20...
## $ language                    &lt;chr&gt; &quot;german&quot;, &quot;german&quot;, &quot;german&quot;, &quot;ger...
## $ source                      &lt;chr&gt; &quot;MARPOR&quot;, &quot;MARPOR&quot;, &quot;MARPOR&quot;, &quot;MAR...
## $ has_eu_code                 &lt;lgl&gt; FALSE, TRUE, TRUE, FALSE, FALSE, F...
## $ is_primary_doc              &lt;lgl&gt; TRUE, TRUE, TRUE, TRUE, TRUE, TRUE...
## $ may_contradict_core_dataset &lt;lgl&gt; FALSE, FALSE, FALSE, FALSE, FALSE,...
## $ md5sum_text                 &lt;chr&gt; &quot;41e90a16558cc94ea37f96c36cc92498&quot;...
## $ url_original                &lt;chr&gt; &quot;/down/originals/2015-1/41113_2002...
## $ md5sum_original             &lt;chr&gt; &quot;CURRENTLY_UNAVAILABLE&quot;, &quot;CURRENTL...
## $ annotations                 &lt;lgl&gt; TRUE, TRUE, TRUE, TRUE, TRUE, TRUE...
## $ handbook                    &lt;chr&gt; &quot;3&quot;, &quot;2&quot;, &quot;2&quot;, &quot;4&quot;, &quot;5&quot;, &quot;3&quot;, &quot;2&quot;,...
## $ is_copy_of                  &lt;lgl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA...
## $ title                       &lt;chr&gt; &quot;Grün wirkt! Unser Wahlprogramm 20...
## $ id                          &lt;chr&gt; &quot;41113_200209&quot;, &quot;41113_200509&quot;, &quot;4...
## $ text                        &lt;chr&gt; &quot;Grün wirkt!\nUnser Wahlprogramm\n...</code></pre>
</div>
<div id="clean-text-data" class="section level2">
<h2>clean text data</h2>
<ul>
<li><a href="https://stat.ethz.ch/R-manual/R-devel/library/base/html/regex.html">Regular Expressions as used in R</a></li>
</ul>
<pre class="r"><code>party_dict &lt;- list(
&quot;greens&quot;= c(&quot;Green Party&quot;, &quot;1&quot;, &quot;41113&quot;, &quot;#46962b&quot;),
&quot;left&quot; = c(&quot;The Left&quot;, &quot;2&quot;, &quot;41223&quot;, &quot;#8B1A1A&quot;),
&quot;spd&quot; = c(&quot;SPD&quot;, &quot;3&quot;, &quot;41320&quot;, &quot;#E2001A&quot;),
&quot;fdp&quot; = c(&quot;FDP&quot;, &quot;4&quot;, &quot;41420&quot;, &quot;#ffed00&quot;),
&quot;union&quot; = c(&quot;CDU/CSU&quot;, &quot;5&quot;,  &quot;41521&quot;, &quot;black&quot;)
#&quot;41953&quot; = c(&quot;AfD&quot;, &quot;6&quot;, &quot;afd&quot;, &quot;#1C86EE&quot;)
)

party_abbrev &lt;- names(party_dict)
party_name &lt;- map_chr(party_dict, function(x) x[1])
party_index &lt;- map_chr(party_dict, function(x) x[2])
party_id &lt;- map_chr(party_dict, function(x) x[3])
party_cols &lt;- map_chr(party_dict, function(x) x[4])


df$party_names &lt;- tx_map_dict(df$party, party_dict, key1 = 3, key2 = 1)
df$party_id &lt;- tx_map_dict(df$party, party_dict, key1 = 3, key2 = 2)</code></pre>
<pre class="r"><code>maxlen &lt;- 30

sp_de &lt;-read.table(&quot;data/german_stopwords_cust.txt&quot;, skip = 9, stringsAsFactors = F) %&gt;%
  rename(words = V1)

df_clean &lt;- df %&gt;%
  #sample_n(size = 1000) %&gt;%
  select(party_id, date, id, text) %&gt;%
  mutate(text = text %&gt;%
    tx_replace_punc() %&gt;%
    #str_replace_all(&quot;[[:digit:]]|[[:punct:]]&quot;, &quot; &quot;) %&gt;%
    tidyTX::tx_spacing()
  ) %&gt;% 
  # unnest_tokens(unit, text, token = &quot;sentences&quot;) %&gt;%
  unnest_tokens(words, text, token = &quot;words&quot;) %&gt;%
  ### build batches from one-token-per-row df
  group_by(party_id) %&gt;%
  # generate splitting id (seq)
  dplyr::mutate(seq = seq_along(words) %/% maxlen) %&gt;%
  #ungroup() %&gt;%
  group_by(party_id, seq) %&gt;%
  summarise(text = paste(words, collapse = &quot; &quot;)) %&gt;%
  ungroup() %&gt;%
  ### exclude AfD 6 due to less data
  mutate(party_id = party_id %&gt;% as.numeric) %&gt;% 
  filter(party_id %in% 1:5) %&gt;%
  ### kick statments shorter than 5 words
  mutate(nwords = tx_n_tokens(text)) %&gt;%
  filter(nwords &gt; 5) %&gt;%
  ### Downsample green party statments
  group_by(party_id) %&gt;%
  sample_n(size = 4000) %&gt;%
  ungroup() %&gt;% 
  ### give a reliabel
  mutate(id = 1:n()) %&gt;%
  tx_discard_tokens(text = &quot;text&quot;, dict = sp_de, purrr = T) %&gt;%
  ### randomize order of statments from parties
  arrange(sample(1:length(id), length(id)))

print(object.size(df_clean), standard = &quot;SI&quot;, units = &quot;MB&quot;)</code></pre>
<pre><code>## 10.8 MB</code></pre>
<pre class="r"><code>df_clean</code></pre>
<pre><code>## # A tibble: 20,000 x 6
##    party_id   seq text                     nwords    id ctext             
##       &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;                     &lt;int&gt; &lt;int&gt; &lt;chr&gt;             
##  1       1. 1263. die wiederaufbereitung …     29  1620 wiederaufbereitun…
##  2       1. 7478. die regionalen wirtscha…     29  2697 regionalen wirtsc…
##  3       2. 1990. dem internet hat sich v…     29  6789 internet veränder…
##  4       4. 3183. soll das gesamtvolumen …     29 12265 gesamtvolumen fin…
##  5       1. 1122. zeigen sich in einzelne…     29  3865 zeigen einzelnen …
##  6       1. 7364. abzug der letzten atomw…     29  1752 abzug letzten ato…
##  7       4. 3432. dafür stark gemacht das…     29 12978 dafür stark gemac…
##  8       4. 2653. für die vergabe von stu…     29 12746 vergabe studienpl…
##  9       3.  303. allen schulen werden pu…     29  8012 schulen punc_dot …
## 10       3. 1177. und für die innere sich…     29  8213 innere sicherheit…
## # ... with 19,990 more rows</code></pre>
</div>
<div id="train-test-set" class="section level2">
<h2>Train &amp; Test Set</h2>
<pre class="r"><code>set.seed(2018)
df_clean$split_id &lt;- sample(1:2, size = nrow(df_clean), replace = T, prob=c(.9, .1))
train &lt;- df_clean %&gt;% filter(split_id %in% 1)
test &lt;- df_clean %&gt;% filter(split_id == 2)</code></pre>
</div>
<div id="keras" class="section level1">
<h1>Keras</h1>
<div id="text-preprocessing" class="section level2">
<h2>Text Preprocessing</h2>
<pre class="r"><code>### vocabluary size
library(ggplot2)
train %&gt;%
  unnest_tokens(words, ctext) %&gt;%
  select(words) %&gt;%
  group_by(words) %&gt;%
  tally %&gt;%
  ggplot(aes(n)) +
  geom_histogram() +
  xlim(0, 100) </code></pre>
<p><img src="/post/2018-03-06-keras_tensorflow_files/figure-html/vocab-1.png" width="672" /></p>
<pre class="r"><code>max_features &lt;- 20000 # top most common words
batch_size &lt;- 32
#maxlen &lt;- 20 # Cut texts after this number of words (called earlier)

#tokenizer &lt;- text_tokenizer(num_words = max_features)
#fit_text_tokenizer(tokenizer, x = train$ctext)
#keras::save_text_tokenizer(tokenizer, &quot;data/tokenizer&quot;)
tokenizer &lt;- keras::load_text_tokenizer(&quot;data/tokenizer&quot;)

train_seq &lt;- tx_text_to_seq(
  token_fun = tokenizer,
  string = train$ctext,
  maxlen = maxlen
)

test_seq &lt;- tx_text_to_seq(
  token_fun = tokenizer,
  string = test$ctext,
  maxlen = maxlen
)</code></pre>
</div>
<div id="fasttext-model" class="section level2">
<h2>fasttext Model</h2>
<pre class="r"><code>glove_fit &lt;- keras_model_sequential() %&gt;%
  layer_embedding(
    input_dim = max_features, 
    output_dim = 128, 
    input_length = maxlen
    ) %&gt;%
  layer_global_average_pooling_1d() %&gt;%
  layer_dense(5, activation = &quot;sigmoid&quot;) %&gt;%
  compile(
    loss = &quot;binary_crossentropy&quot;,
    optimizer = &quot;adam&quot;,
    metrics = &quot;accuracy&quot;
  )

summary(glove_fit)</code></pre>
<pre><code>## ___________________________________________________________________________
## Layer (type)                     Output Shape                  Param #     
## ===========================================================================
## embedding_1 (Embedding)          (None, 30, 128)               2560000     
## ___________________________________________________________________________
## global_average_pooling1d_1 (Glob (None, 128)                   0           
## ___________________________________________________________________________
## dense_1 (Dense)                  (None, 5)                     645         
## ===========================================================================
## Total params: 2,560,645
## Trainable params: 2,560,645
## Non-trainable params: 0
## ___________________________________________________________________________</code></pre>
<pre class="r"><code>glove_hist &lt;- glove_fit %&gt;% 
  keras::fit(
    x = train_seq, 
    y = tx_onehot(train$party_id),
    batch_size = batch_size,
    epochs = 5, 
    validation_split = .2
  )</code></pre>
<pre class="r"><code>#plot(glove_hist)
preds_glove &lt;- glove_fit %&gt;%
  tx_keras_predict(test_seq, 1) %&gt;% 
  as.vector()

caret::confusionMatrix(preds_glove, test$party_id)</code></pre>
<pre><code>## Confusion Matrix and Statistics
## 
##           Reference
## Prediction   1   2   3   4   5
##          1 233  28  52  34  28
##          2  67 324  46  19   5
##          3  36  11 181  17  30
##          4  24  14  35 258  31
##          5  49  11  70  69 334
## 
## Overall Statistics
##                                           
##                Accuracy : 0.663           
##                  95% CI : (0.6419, 0.6837)
##     No Information Rate : 0.2134          
##     P-Value [Acc &gt; NIR] : &lt; 2.2e-16       
##                                           
##                   Kappa : 0.5781          
##  Mcnemar&#39;s Test P-Value : 1.644e-14       
## 
## Statistics by Class:
## 
##                      Class: 1 Class: 2 Class: 3 Class: 4 Class: 5
## Sensitivity            0.5697   0.8351  0.47135   0.6499   0.7804
## Specificity            0.9111   0.9153  0.94205   0.9354   0.8739
## Pos Pred Value         0.6213   0.7028  0.65818   0.7127   0.6266
## Neg Pred Value         0.8921   0.9586  0.88273   0.9155   0.9362
## Prevalence             0.2039   0.1934  0.19143   0.1979   0.2134
## Detection Rate         0.1162   0.1615  0.09023   0.1286   0.1665
## Detection Prevalence   0.1869   0.2298  0.13709   0.1805   0.2657
## Balanced Accuracy      0.7404   0.8752  0.70670   0.7926   0.8271</code></pre>
<pre class="r"><code>tx_confusion(x = preds_glove, y = test$party_id, lib = &quot;gg&quot;)</code></pre>
<p><img src="/post/2018-03-06-keras_tensorflow_files/figure-html/pred1-1.png" width="672" /></p>
</div>
<div id="lstm-model" class="section level2">
<h2>LSTM model</h2>
<pre class="r"><code>lstm_fit &lt;- keras_model_sequential() %&gt;%
  ### model arch
  layer_embedding(
    input_dim = max_features, 
    output_dim = 128, 
    input_length = maxlen
  ) %&gt;% 
  layer_lstm(units = 64, dropout = 0.3, recurrent_dropout = 0.1) %&gt;% 
  layer_dense(units = 5, activation = &#39;sigmoid&#39;) %&gt;%
  ### compiler
  compile(
    loss = &#39;binary_crossentropy&#39;,
    optimizer = &#39;adam&#39;,
    metrics = c(&#39;accuracy&#39;)
  )

summary(lstm_fit)</code></pre>
<pre><code>## ___________________________________________________________________________
## Layer (type)                     Output Shape                  Param #     
## ===========================================================================
## embedding_2 (Embedding)          (None, 30, 128)               2560000     
## ___________________________________________________________________________
## lstm_1 (LSTM)                    (None, 64)                    49408       
## ___________________________________________________________________________
## dense_2 (Dense)                  (None, 5)                     325         
## ===========================================================================
## Total params: 2,609,733
## Trainable params: 2,609,733
## Non-trainable params: 0
## ___________________________________________________________________________</code></pre>
<pre class="r"><code>lstm_hist &lt;- lstm_fit %&gt;% 
  keras::fit(
    x = train_seq, 
    y = tx_onehot(train$party_id),
    batch_size = batch_size,
    epochs = 3,
    validation_split = .2
  )</code></pre>
<pre class="r"><code># tx_keras_plot(lstm_hist)
preds_lstm &lt;- lstm_fit %&gt;% 
  tx_keras_predict(test_seq, 1)

nn &lt;- tibble(preds_lstm, test$party_id) %&gt;%
  mutate(real = preds_lstm == test$party_id)
prop.table(table(nn$real))</code></pre>
<pre><code>## 
##     FALSE      TRUE 
## 0.3035892 0.6964108</code></pre>
<pre class="r"><code>#dm[[3]] %&gt;% hist

caret::confusionMatrix(preds_lstm, test$party_id)</code></pre>
<pre><code>## Confusion Matrix and Statistics
## 
##           Reference
## Prediction   1   2   3   4   5
##          1 212  13  38  20   9
##          2  71 333  34  17   5
##          3  71  31 225  28  36
##          4  25   9  26 280  31
##          5  30   2  61  52 347
## 
## Overall Statistics
##                                           
##                Accuracy : 0.6964          
##                  95% CI : (0.6758, 0.7165)
##     No Information Rate : 0.2134          
##     P-Value [Acc &gt; NIR] : &lt; 2.2e-16       
##                                           
##                   Kappa : 0.6204          
##  Mcnemar&#39;s Test P-Value : 1.468e-12       
## 
## Statistics by Class:
## 
##                      Class: 1 Class: 2 Class: 3 Class: 4 Class: 5
## Sensitivity            0.5183   0.8582   0.5859   0.7053   0.8107
## Specificity            0.9499   0.9215   0.8977   0.9434   0.9081
## Pos Pred Value         0.7260   0.7239   0.5754   0.7547   0.7053
## Neg Pred Value         0.8851   0.9644   0.9015   0.9284   0.9465
## Prevalence             0.2039   0.1934   0.1914   0.1979   0.2134
## Detection Rate         0.1057   0.1660   0.1122   0.1396   0.1730
## Detection Prevalence   0.1456   0.2293   0.1949   0.1849   0.2453
## Balanced Accuracy      0.7341   0.8899   0.7418   0.8244   0.8594</code></pre>
<pre class="r"><code>tx_confusion(x = preds_lstm, y = test$party_id, lib = &quot;gg&quot;, info = F)</code></pre>
<p><img src="/post/2018-03-06-keras_tensorflow_files/figure-html/fit2-1.png" width="672" /></p>
</div>
</div>

</main>



      </div>
      <div class="three wide column"></div>
      
    </div>
    <br>
    <br>
    <footer>
    <div class="ui blue inverted bottom attached vertical segment">
      <br>
      <br>
      <div class="ui container">
        <div class="ui stackable inverted divided equal height stackable grid">
          <div class="three wide column">
            <h4 class="ui inverted header">About</h4>
            <div class="ui inverted link list">
              <a href="#" class="item">Sitemap</a>
              <a href="#" class="item">Contact Us</a>
              <a href="#" class="item">Religious Ceremonies</a>
              <a href="#" class="item">Gazebo Plans</a>
            </div>
          </div>
          <div class="three wide column">
            <h4 class="ui inverted header">Services</h4>
            <div class="ui inverted link list">
              <a href="#" class="item">Banana Pre-Order</a>
              <a href="#" class="item">DNA FAQ</a>
              <a href="https://en.wiktionary.org/wiki/sapiosexual" target="_blank" class="item">Sapiosexuality</a>
              <a href="#" class="item">Favorite X-Men</a>
            </div>
          </div>
          <div class="seven wide column">
            <h4 class="ui inverted header">Let's connect!</h4>
            <p>
              <a href="" target="_blank" rel="nofollow" class = "ui circular icon inverted button">
                <i class="inverted blue facebook icon large"></i>
              </a>
              <a href="https://twitter.com/systatz" target="_blank" rel="nofollow" class = "ui circular icon inverted button">
                <i class="inverted blue twitter icon large"></i>
              </a>
              <a href="https://github.com/systats" target="_blank" rel="nofollow" class = "ui circular icon inverted button">
                <i class="inverted blue github icon large"></i>
              </a>
              <a href="mailto:sy-ro@gmx.net" target="_blank" rel="nofollow" class = "ui circular icon inverted button">
                <i class="inverted blue mail icon large"></i>
              </a>
            </p>
          </div>
        </div>
      </div>
      <br>
      <br>
    </div>
    </footer>
    <script>
      $('.ui.dropdown').dropdown();
      $('.tabular.menu .item').tab();
      hljs.initHighlightingOnLoad();
    </script>
  </body>
  
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-114717666-1', 'auto');
ga('send', 'pageview');
</script>

</html>

